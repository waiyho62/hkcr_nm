<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTHORS AND KEYWORDS</title>
    <style> html{font-size:120%;}</style>
</head>

<body style="background-color:#ece6ff;">
<ul style="font-size:120%">
<li><a href="./index.html">Index Page</a></li>
</ul>



    <h2 style="font-size:200%;"> AUTHORS AND KEYWORDS</h2>
    <form action="javascript:markPages();">

        <label for="myAuthorFile" id="label">Select "Authors.txt":</label>
        <input id="myAuthorFile" type="file" accept=".txt" onchange="showText('myAuthorFile', 'myTextArea')">
        <textarea id="myTextArea" cols="20" rows="1" disabled="disabled" required=""></textarea>
        <br><br>

        <label for="myKeywordFile" id="label">Select "KeywordsByTopics.txt":</label>
        <input id="myKeywordFile" type="file" accept=".txt" onchange="showText2('myKeywordFile', 'myTextArea2')" disabled>
        <textarea id="myTextArea2" cols="18" rows="1" disabled="disabled" required=""></textarea>
        <br><br>

        <button type="button" id="prepare-button" disabled>Prepare Zip File</button>
        <button type="button" id="reset" onclick="resetPage()">Reset Page</button>
        <a style="display:none" id="download-link" download="Javascript file">Download Zip File</a>
    
    <br><br>
    <label for="javascriptFile">Javascript File</label>
    <input type="text" id="fileName" name="FileName" size="22" disabled="disabled">
    <br><br>
    <textarea id="javascriptFile" name="javascriptFile" rows="10" cols="96" disabled="disabled"></textarea>
    <br><br>

<h2>Instructions:</h2>
<ol>
<li>This page generates Javascript files for the selectable drop-down lists for MCQ templates. </li>
<li>Select the text file generated by the MCQ Database for the author list.</li>
<li>Select the text file generated by the MCQ Database for the keyword lists.</li>
<li>Press the button [Prepare Zip File] to download a zip file (Javascript file.zip) containing the Javascript file for upload to the MCQ server.</li>
</ol>



    <script src="./jszip.min.js"></script>

    <script>

const downloadLink = document.querySelector("#download-link");
const prepareButton = document.querySelector("#prepare-button");
let JSFileName;

function showText(fileId, areaId) {
    let file = document.getElementById(fileId).files[0];
    let f = file.name;
    getJSFileName(f);
    let reader = new FileReader();
    reader.onload = function (e) {
        let textArea = document.getElementById(areaId);
        textArea.value = e.target.result;
        javascriptFile.value = createAuthorList(areaId);
        myKeywordFile.removeAttribute("disabled");
    };
    reader.readAsText(file);
}

function showText2(fileId, areaId) {
    let file = document.getElementById(fileId).files[0];
    let reader = new FileReader();
    reader.onload = function (e) {
        let textArea = document.getElementById(areaId);
        textArea.value = e.target.result;
        javascriptFile.value = javascriptFile.value + createKeywordLists(areaId);
        let theButton = document.getElementById("prepare-button");
        theButton.removeAttribute("disabled");
    };
    reader.readAsText(file);
}

function getJSFileName(f) {
    if (f.includes("Physics")) {
        JSFileName = "Physics.js";
        fileName.value = JSFileName;
    };
    if (f.includes("Clinical")) {
        JSFileName = "Clinical.js";
        fileName.value = JSFileName;
    };
    if (f.includes("PartII")) {
        JSFileName = "Final.js";
        fileName.value = JSFileName;
    };
}

function createAuthorList(textArea) {
    let string = document.getElementById(textArea).value;
    string = "const authors = [" + "\n" + string.replaceAll("\n", "," + "\n");
    string = string.substring(0, string.length - 2) + "\n" + "];" + "\n" + "\n";

    return string;    
}

function createKeywordLists(textArea) {
    let string = document.getElementById(textArea).value;
    for (i=0; i<14; i++) {
        string = string.replace((i+1) + ",", 
            "];" + "\n\n" + "keywordsByTopic['" + (i+1) + "'] = [" + "\n");
    };
    for (i=0; i<14; i++) {
        string = string.replaceAll("\n" + (i+1) + ",", "," + "\n"); 
    };
    string = ("const keywordsByTopic = [" + string + "];");
    return string;

}

prepareButton.onclick = function () {

    const zipFile = new JSZip();

    const currDate = new Date();
    const dateWithOffset = new Date(currDate.getTime() - currDate.getTimezoneOffset() * 60000);
    // replace the default date with dateWithOffset
    JSZip.defaults.date = dateWithOffset;

    zipFile.file(JSFileName, javascriptFile.value);

    zipFile.generateAsync({ type: "blob" }).then(function (zipFileBlob) {
        const zipFileUrl = URL.createObjectURL(zipFileBlob);
        downloadLink.setAttribute("href", zipFileUrl);
        document.getElementById("download-link").click();     
        setTimeout(() => {
            resetPage();
        }, 1000);
    })
}


function resetPage() {
    window.location = window.location.href
}



    </script>


</body></html>